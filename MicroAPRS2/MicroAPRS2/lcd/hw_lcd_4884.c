
#include "hw_lcd_4884.h"

#include <net/afsk.h>
#include <cpu/irq.h>

#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

#include <drv/timer.h>

/*
 * PIN Configuragion
 *
 * PORTC(1)/D15/A1 -> CLK
 * PORTC(2)/D16/A2 -> DIN
 * PORTC(3)/D17/A3 -> DC
 * PORTC(4)/D18/A4 -> SCE
 * PORTC(5)/D19/A5 -> RST
 */

#define PIN_SCLK 1
#define PIN_SDIN 2
#define PIN_DC 3
#define PIN_SCE 4
#define PIN_RESET 5

#define HI(x) PORTC |= BV(x)
#define LO(x) PORTC &= ~BV(x)

///////////////////////////////////////////////
// Internal variables
///////////////////////////////////////////////
// The size of the display, in pixels...
#define width 84
#define height 48

#define NUM_COL 14
#define NUM_ROW 5

// Current cursor position...
static unsigned char pix_x;
static unsigned char pix_y;

#define PCD8544_CMD  0
#define PCD8544_DATA 1

///////////////////////////////////////////////
// Internal functions
///////////////////////////////////////////////


///////////////////////////////////////////////
// Public functions
///////////////////////////////////////////////
void lcd_4884_init(){
	DDRC |= 62;//00111110 (BV(PIN_SCLK)|BV(PIN_SDIN)|BV(PIN_DC)|BV(PIN_RESET)|BV(PIN_SCE));
	PORTC |= 62;
#if 0
	for(uint16_t i = 0;i < 1000;i++){
		if(i % 2 == 0)
			HI(PIN_SCLK);
			//PORTC |= 62;
		else{
			//PORTC &= ~62;
			LO(PIN_SCLK);
		}
		timer_delay(1000);
	}
#else
	// reset the controller
	HI(PIN_RESET);
	timer_delay(1);
	LO(PIN_RESET);
	timer_delay(1);
	HI(PIN_RESET);
	timer_delay(100);

	/*
	LO(PIN_SCE);
	timer_delay(1);
	HI(PIN_SCE);
	*/

	// set parameters
	lcd_4884_sendCommand(PCD8544_CMD, 0x21); // extended instruction set control (H=1)
	lcd_4884_sendCommand(PCD8544_CMD, 0xc0); // bias system (1:48)

	lcd_4884_sendCommand(PCD8544_CMD, 0x06);
	lcd_4884_sendCommand(PCD8544_CMD, 0x13);
	lcd_4884_sendCommand(PCD8544_CMD, 0x20); // set enable

	lcd_4884_clear();
	lcd_4884_sendCommand(PCD8544_CMD, 0x0c); // normal mode(0x0d = inverse mode)

	// all done, keep low of PIN_SCE
	LO(PIN_SCE);

	/*
#if defined(CHIP_ST7576) && CHIP_ST7576 == 1
	lcd_4884_sendCommand(PCD8544_CMD,0xe0);
	lcd_4884_sendCommand(PCD8544_CMD,0x05);
#else
	lcd_4884_sendCommand(PCD8544_CMD,0xc2);
#endif
	lcd_4884_sendCommand(PCD8544_CMD,0x20);
	lcd_4884_sendCommand(PCD8544_CMD,0x09);

	// clear the ram
	lcd_4884_clear();

	lcd_4884_sendCommand(PCD8544_CMD,0x08); //display blank
	lcd_4884_sendCommand(PCD8544_CMD,0x0c); // normal mode(0x0d = inverse mode)
	timer_delay(100);

	// reset cursor
	lcd_4884_sendCommand(PCD8544_CMD,0x80);
	lcd_4884_sendCommand(PCD8544_CMD,0x40);
	*/
#endif
}

void lcd_4884_sendCommand(uint8_t type, uint8_t data){
	uint8_t i;

	LO(PIN_SCE);
	if(type == 0){
		LO(PIN_DC);
	}else{
		HI(PIN_DC);
	}

	// shift data out
	for (i = 0; i < 8; i++) {
		/*
		if((data & (1 << (7 - i)))){
			HI(PIN_SDIN);
		}else{
			LO(PIN_SDIN);
		}
		LO(PIN_SCLK);
		HI(PIN_SCLK);
		*/
		if(data& 0x80) {
			HI(PIN_SDIN);
		} else {
			LO(PIN_SDIN);
		}
		LO(PIN_SCLK);
		data = data << 1;
		HI(PIN_SCLK);
	}

	HI(PIN_SCE);
}

void lcd_4884_setEnable(uint8_t enable){
	lcd_4884_sendCommand(PCD8544_CMD, enable ? 0x20 : 0x24);
}

#define lcd_4884_home() lcd_4884_setCursor(0,pix_y)


void lcd_4884_setCursor(uint8_t x, uint8_t y){

	pix_x = x % width;
	pix_y = y % height;

	lcd_4884_sendCommand(PCD8544_CMD,0x80 | pix_x);
	lcd_4884_sendCommand(PCD8544_CMD,0x40 | pix_y);
}


void lcd_4884_clear() {
	lcd_4884_setCursor(0, 0);
	// the font 6x8 is 6 pix width and 8 pix height
	for (uint16_t i = 0; i < width * (height / 8) /*504*/; i++) {
		lcd_4884_sendCommand(PCD8544_DATA, 0x00);
	}
	lcd_4884_setCursor(0, 0);
}

void lcd_4884_clearLine(uint8_t aline){
	lcd_4884_setCursor(0, aline);
	for (uint16_t i = 0; i < width; i++) {
		lcd_4884_sendCommand(PCD8544_DATA, 0x00);
	}
	lcd_4884_setCursor(0, aline);
}

void lcd_4884_writeString(const char* str,uint8_t aline){
	uint16_t i;
	// move to the line
	lcd_4884_setCursor(0,aline);
	lcd_4884_clearLine(aline);
	// total chars = 84 * 48 / 6 / 9

	for(i = 0; i < 14/*total ((height * width) - (line * column))*/ ;i++){
		if(str[i] == 0)
			break;
		lcd_4884_write(str[i]);
	}
}

///////////////////////////////////////////////
// The 7-bit ASCII character set...
const PROGMEM unsigned char charset[][5] = {
	    { 0x00, 0x00, 0x00, 0x00, 0x00 },   // sp
	    { 0x00, 0x00, 0x2f, 0x00, 0x00 },   // !
	    { 0x00, 0x07, 0x00, 0x07, 0x00 },   // "
	    { 0x14, 0x7f, 0x14, 0x7f, 0x14 },   // #
	    { 0x24, 0x2a, 0x7f, 0x2a, 0x12 },   // $
	    { 0x62, 0x64, 0x08, 0x13, 0x23 },   // %
	    { 0x36, 0x49, 0x55, 0x22, 0x50 },   // &
	    { 0x00, 0x05, 0x03, 0x00, 0x00 },   // '
	    { 0x00, 0x1c, 0x22, 0x41, 0x00 },   // (
	    { 0x00, 0x41, 0x22, 0x1c, 0x00 },   // )
	    { 0x14, 0x08, 0x3E, 0x08, 0x14 },   // *
	    { 0x08, 0x08, 0x3E, 0x08, 0x08 },   // +
	    { 0x00, 0x00, 0xA0, 0x60, 0x00 },   // ,
	    { 0x08, 0x08, 0x08, 0x08, 0x08 },   // -
	    { 0x00, 0x60, 0x60, 0x00, 0x00 },   // .
	    { 0x20, 0x10, 0x08, 0x04, 0x02 },   // /
	    { 0x3E, 0x51, 0x49, 0x45, 0x3E },   // 0
	    { 0x00, 0x42, 0x7F, 0x40, 0x00 },   // 1
	    { 0x42, 0x61, 0x51, 0x49, 0x46 },   // 2
	    { 0x21, 0x41, 0x45, 0x4B, 0x31 },   // 3
	    { 0x18, 0x14, 0x12, 0x7F, 0x10 },   // 4
	    { 0x27, 0x45, 0x45, 0x45, 0x39 },   // 5
	    { 0x3C, 0x4A, 0x49, 0x49, 0x30 },   // 6
	    { 0x01, 0x71, 0x09, 0x05, 0x03 },   // 7
	    { 0x36, 0x49, 0x49, 0x49, 0x36 },   // 8
	    { 0x06, 0x49, 0x49, 0x29, 0x1E },   // 9
	    { 0x00, 0x36, 0x36, 0x00, 0x00 },   // :
	    { 0x00, 0x56, 0x36, 0x00, 0x00 },   // ;
	    { 0x08, 0x14, 0x22, 0x41, 0x00 },   // <
	    { 0x14, 0x14, 0x14, 0x14, 0x14 },   // =
	    { 0x00, 0x41, 0x22, 0x14, 0x08 },   // >
	    { 0x02, 0x01, 0x51, 0x09, 0x06 },   // ?
	    { 0x32, 0x49, 0x59, 0x51, 0x3E },   // @
	    { 0x7C, 0x12, 0x11, 0x12, 0x7C },   // A
	    { 0x7F, 0x49, 0x49, 0x49, 0x36 },   // B
	    { 0x3E, 0x41, 0x41, 0x41, 0x22 },   // C
	    { 0x7F, 0x41, 0x41, 0x22, 0x1C },   // D
	    { 0x7F, 0x49, 0x49, 0x49, 0x41 },   // E
	    { 0x7F, 0x09, 0x09, 0x09, 0x01 },   // F
	    { 0x3E, 0x41, 0x49, 0x49, 0x7A },   // G
	    { 0x7F, 0x08, 0x08, 0x08, 0x7F },   // H
	    { 0x00, 0x41, 0x7F, 0x41, 0x00 },   // I
	    { 0x20, 0x40, 0x41, 0x3F, 0x01 },   // J
	    { 0x7F, 0x08, 0x14, 0x22, 0x41 },   // K
	    { 0x7F, 0x40, 0x40, 0x40, 0x40 },   // L
	    { 0x7F, 0x02, 0x0C, 0x02, 0x7F },   // M
	    { 0x7F, 0x04, 0x08, 0x10, 0x7F },   // N
	    { 0x3E, 0x41, 0x41, 0x41, 0x3E },   // O
	    { 0x7F, 0x09, 0x09, 0x09, 0x06 },   // P
	    { 0x3E, 0x41, 0x51, 0x21, 0x5E },   // Q
	    { 0x7F, 0x09, 0x19, 0x29, 0x46 },   // R
	    { 0x46, 0x49, 0x49, 0x49, 0x31 },   // S
	    { 0x01, 0x01, 0x7F, 0x01, 0x01 },   // T
	    { 0x3F, 0x40, 0x40, 0x40, 0x3F },   // U
	    { 0x1F, 0x20, 0x40, 0x20, 0x1F },   // V
	    { 0x3F, 0x40, 0x38, 0x40, 0x3F },   // W
	    { 0x63, 0x14, 0x08, 0x14, 0x63 },   // X
	    { 0x07, 0x08, 0x70, 0x08, 0x07 },   // Y
	    { 0x61, 0x51, 0x49, 0x45, 0x43 },   // Z
	    { 0x00, 0x7F, 0x41, 0x41, 0x00 },   // [
	    { 0x55, 0x2A, 0x55, 0x2A, 0x55 },   // 55
	    { 0x00, 0x41, 0x41, 0x7F, 0x00 },   // ]
	    { 0x04, 0x02, 0x01, 0x02, 0x04 },   // ^
	    { 0x40, 0x40, 0x40, 0x40, 0x40 },   // _
	    { 0x00, 0x01, 0x02, 0x04, 0x00 },   // '
	    { 0x20, 0x54, 0x54, 0x54, 0x78 },   // a
	    { 0x7F, 0x48, 0x44, 0x44, 0x38 },   // b
	    { 0x38, 0x44, 0x44, 0x44, 0x20 },   // c
	    { 0x38, 0x44, 0x44, 0x48, 0x7F },   // d
	    { 0x38, 0x54, 0x54, 0x54, 0x18 },   // e
	    { 0x08, 0x7E, 0x09, 0x01, 0x02 },   // f
	    { 0x18, 0xA4, 0xA4, 0xA4, 0x7C },   // g
	    { 0x7F, 0x08, 0x04, 0x04, 0x78 },   // h
	    { 0x00, 0x44, 0x7D, 0x40, 0x00 },   // i
	    { 0x40, 0x80, 0x84, 0x7D, 0x00 },   // j
	    { 0x7F, 0x10, 0x28, 0x44, 0x00 },   // k
	    { 0x00, 0x41, 0x7F, 0x40, 0x00 },   // l
	    { 0x7C, 0x04, 0x18, 0x04, 0x78 },   // m
	    { 0x7C, 0x08, 0x04, 0x04, 0x78 },   // n
	    { 0x38, 0x44, 0x44, 0x44, 0x38 },   // o
	    { 0xFC, 0x24, 0x24, 0x24, 0x18 },   // p
	    { 0x18, 0x24, 0x24, 0x18, 0xFC },   // q
	    { 0x7C, 0x08, 0x04, 0x04, 0x08 },   // r
	    { 0x48, 0x54, 0x54, 0x54, 0x20 },   // s
	    { 0x04, 0x3F, 0x44, 0x40, 0x20 },   // t
	    { 0x3C, 0x40, 0x40, 0x20, 0x7C },   // u
	    { 0x1C, 0x20, 0x40, 0x20, 0x1C },   // v
	    { 0x3C, 0x40, 0x30, 0x40, 0x3C },   // w
	    { 0x44, 0x28, 0x10, 0x28, 0x44 },   // x
	    { 0x1C, 0xA0, 0xA0, 0xA0, 0x7C },   // y
	    { 0x44, 0x64, 0x54, 0x4C, 0x44 },   // z
	    { 0x00, 0x06, 0x09, 0x09, 0x06 }    // horiz lines
/*
  { 0x00, 0x00, 0x00, 0x00, 0x00 },  // 20 space
  { 0x00, 0x00, 0x5f, 0x00, 0x00 },  // 21 !
  { 0x00, 0x07, 0x00, 0x07, 0x00 },  // 22 "
  { 0x14, 0x7f, 0x14, 0x7f, 0x14 },  // 23 #
  { 0x24, 0x2a, 0x7f, 0x2a, 0x12 },  // 24 $
  { 0x23, 0x13, 0x08, 0x64, 0x62 },  // 25 %
  { 0x36, 0x49, 0x55, 0x22, 0x50 },  // 26 &
  { 0x00, 0x05, 0x03, 0x00, 0x00 },  // 27 '
  { 0x00, 0x1c, 0x22, 0x41, 0x00 },  // 28 (
  { 0x00, 0x41, 0x22, 0x1c, 0x00 },  // 29 )
  { 0x14, 0x08, 0x3e, 0x08, 0x14 },  // 2a *
  { 0x08, 0x08, 0x3e, 0x08, 0x08 },  // 2b +
  { 0x00, 0x50, 0x30, 0x00, 0x00 },  // 2c ,
  { 0x08, 0x08, 0x08, 0x08, 0x08 },  // 2d -
  { 0x00, 0x60, 0x60, 0x00, 0x00 },  // 2e .
  { 0x20, 0x10, 0x08, 0x04, 0x02 },  // 2f /
  { 0x3e, 0x51, 0x49, 0x45, 0x3e },  // 30 0
  { 0x00, 0x42, 0x7f, 0x40, 0x00 },  // 31 1
  { 0x42, 0x61, 0x51, 0x49, 0x46 },  // 32 2
  { 0x21, 0x41, 0x45, 0x4b, 0x31 },  // 33 3
  { 0x18, 0x14, 0x12, 0x7f, 0x10 },  // 34 4
  { 0x27, 0x45, 0x45, 0x45, 0x39 },  // 35 5
  { 0x3c, 0x4a, 0x49, 0x49, 0x30 },  // 36 6
  { 0x01, 0x71, 0x09, 0x05, 0x03 },  // 37 7
  { 0x36, 0x49, 0x49, 0x49, 0x36 },  // 38 8
  { 0x06, 0x49, 0x49, 0x29, 0x1e },  // 39 9
  { 0x00, 0x36, 0x36, 0x00, 0x00 },  // 3a :
  { 0x00, 0x56, 0x36, 0x00, 0x00 },  // 3b ;
  { 0x08, 0x14, 0x22, 0x41, 0x00 },  // 3c <
  { 0x14, 0x14, 0x14, 0x14, 0x14 },  // 3d =
  { 0x00, 0x41, 0x22, 0x14, 0x08 },  // 3e >
  { 0x02, 0x01, 0x51, 0x09, 0x06 },  // 3f ?
  { 0x32, 0x49, 0x79, 0x41, 0x3e },  // 40 @
  { 0x7e, 0x11, 0x11, 0x11, 0x7e },  // 41 A
  { 0x7f, 0x49, 0x49, 0x49, 0x36 },  // 42 B
  { 0x3e, 0x41, 0x41, 0x41, 0x22 },  // 43 C
  { 0x7f, 0x41, 0x41, 0x22, 0x1c },  // 44 D
  { 0x7f, 0x49, 0x49, 0x49, 0x41 },  // 45 E
  { 0x7f, 0x09, 0x09, 0x09, 0x01 },  // 46 F
  { 0x3e, 0x41, 0x49, 0x49, 0x7a },  // 47 G
  { 0x7f, 0x08, 0x08, 0x08, 0x7f },  // 48 H
  { 0x00, 0x41, 0x7f, 0x41, 0x00 },  // 49 I
  { 0x20, 0x40, 0x41, 0x3f, 0x01 },  // 4a J
  { 0x7f, 0x08, 0x14, 0x22, 0x41 },  // 4b K
  { 0x7f, 0x40, 0x40, 0x40, 0x40 },  // 4c L
  { 0x7f, 0x02, 0x0c, 0x02, 0x7f },  // 4d M
  { 0x7f, 0x04, 0x08, 0x10, 0x7f },  // 4e N
  { 0x3e, 0x41, 0x41, 0x41, 0x3e },  // 4f O
  { 0x7f, 0x09, 0x09, 0x09, 0x06 },  // 50 P
  { 0x3e, 0x41, 0x51, 0x21, 0x5e },  // 51 Q
  { 0x7f, 0x09, 0x19, 0x29, 0x46 },  // 52 R
  { 0x46, 0x49, 0x49, 0x49, 0x31 },  // 53 S
  { 0x01, 0x01, 0x7f, 0x01, 0x01 },  // 54 T
  { 0x3f, 0x40, 0x40, 0x40, 0x3f },  // 55 U
  { 0x1f, 0x20, 0x40, 0x20, 0x1f },  // 56 V
  { 0x3f, 0x40, 0x38, 0x40, 0x3f },  // 57 W
  { 0x63, 0x14, 0x08, 0x14, 0x63 },  // 58 X
  { 0x07, 0x08, 0x70, 0x08, 0x07 },  // 59 Y
  { 0x61, 0x51, 0x49, 0x45, 0x43 },  // 5a Z
  { 0x00, 0x7f, 0x41, 0x41, 0x00 },  // 5b [
  { 0x02, 0x04, 0x08, 0x10, 0x20 },  // 5c backslash
  { 0x00, 0x41, 0x41, 0x7f, 0x00 },  // 5d ]
  { 0x04, 0x02, 0x01, 0x02, 0x04 },  // 5e ^
  { 0x40, 0x40, 0x40, 0x40, 0x40 },  // 5f _
  { 0x00, 0x01, 0x02, 0x04, 0x00 },  // 60 `
  { 0x20, 0x54, 0x54, 0x54, 0x78 },  // 61 a
  { 0x7f, 0x48, 0x44, 0x44, 0x38 },  // 62 b
  { 0x38, 0x44, 0x44, 0x44, 0x20 },  // 63 c
  { 0x38, 0x44, 0x44, 0x48, 0x7f },  // 64 d
  { 0x38, 0x54, 0x54, 0x54, 0x18 },  // 65 e
  { 0x08, 0x7e, 0x09, 0x01, 0x02 },  // 66 f
  { 0x0c, 0x52, 0x52, 0x52, 0x3e },  // 67 g
  { 0x7f, 0x08, 0x04, 0x04, 0x78 },  // 68 h
  { 0x00, 0x44, 0x7d, 0x40, 0x00 },  // 69 i
  { 0x20, 0x40, 0x44, 0x3d, 0x00 },  // 6a j
  { 0x7f, 0x10, 0x28, 0x44, 0x00 },  // 6b k
  { 0x00, 0x41, 0x7f, 0x40, 0x00 },  // 6c l
  { 0x7c, 0x04, 0x18, 0x04, 0x78 },  // 6d m
  { 0x7c, 0x08, 0x04, 0x04, 0x78 },  // 6e n
  { 0x38, 0x44, 0x44, 0x44, 0x38 },  // 6f o
  { 0x7c, 0x14, 0x14, 0x14, 0x08 },  // 70 p
  { 0x08, 0x14, 0x14, 0x18, 0x7c },  // 71 q
  { 0x7c, 0x08, 0x04, 0x04, 0x08 },  // 72 r
  { 0x48, 0x54, 0x54, 0x54, 0x20 },  // 73 s
  { 0x04, 0x3f, 0x44, 0x40, 0x20 },  // 74 t
  { 0x3c, 0x40, 0x40, 0x20, 0x7c },  // 75 u
  { 0x1c, 0x20, 0x40, 0x20, 0x1c },  // 76 v
  { 0x3c, 0x40, 0x30, 0x40, 0x3c },  // 77 w
  { 0x44, 0x28, 0x10, 0x28, 0x44 },  // 78 x
  { 0x0c, 0x50, 0x50, 0x50, 0x3c },  // 79 y
  { 0x44, 0x64, 0x54, 0x4c, 0x44 },  // 7a z
  { 0x00, 0x08, 0x36, 0x41, 0x00 },  // 7b {
  { 0x00, 0x00, 0x7f, 0x00, 0x00 },  // 7c |
  { 0x00, 0x41, 0x36, 0x08, 0x00 },  // 7d }
  { 0x10, 0x08, 0x08, 0x10, 0x08 },  // 7e ~
  { 0x00, 0x00, 0x00, 0x00, 0x00 }   // 7f
*/
};


void lcd_4884_write(uint8_t chr){
	if(chr >= 0x80 || chr < 0x20 /*the space ' ' char*/) return;

    const unsigned char *glyph;
	#define pgm_buffer_size 5
    unsigned char pgm_buffer[pgm_buffer_size];
    if (chr >= ' ') {
        // Regular ASCII characters are kept in flash to save RAM...
        memcpy_P(pgm_buffer, &charset[chr - ' '], pgm_buffer_size);
        glyph = pgm_buffer;
    } else {
    	return;
    }

    // Output one column at a time...
    // One column between characters...
    lcd_4884_sendCommand(PCD8544_DATA, 0x00);
    //lcd_4884_sendCommand(PCD8544_DATA, 0); // the first byte of glyph is always 0
    for (unsigned char i = 0; i < pgm_buffer_size; i++) {
        lcd_4884_sendCommand(PCD8544_DATA, glyph[i]);
    }

    // Update the cursor position...
    pix_x = (pix_x + 6) % width;

    if (pix_x == 0) {
        pix_y = (pix_y + 1) % height;
    }
}
